<!DOCTYPE html>
<html>
<head>
  <title>Effets lumineux dynamiques</title>
  <style>
    #effetlumieres div {
      margin: 5px 0;
      padding: 5px;
      border: 1px dashed #ccc;
    }
  </style>
</head>
<body>
  <h1>💡 Construire une séquence lumineuse</h1>

  <form method="post" action="/effet">
    <button type="button" onclick="ajouterTexte()">➕ Ajouter un nom de mode</button>
    <button type="button" onclick="ajouterCouleur()">🎨 Ajouter une couleur</button>
    <button type="button" onclick="ajouterAllumer()">💡 Allumer la lumière</button>
    <button type="button" onclick="ajouterEteindre()">🌑 Éteindre la lampe</button>
    <button type="button" onclick="ajouterPause()">⏸️ Ajouter une pause</button>

    <br><br>
    <input type="hidden" name="effets_json" id="effets_json">
    <button type="submit" onclick="preparerEffets()">🚀 Envoyer</button>
  </form>

  <h2>🧩 Séquence construite :</h2>
  <div id="effetlumieres"></div>

  <script>
    let compteur = 0;

    function ajouterTexte() {
      const div = document.createElement("div");
      div.innerHTML = `<label>Mode :</label> <input type="text" name="mode" data-type="mode" data-id="${++compteur}">`;
      document.getElementById("effetlumieres").appendChild(div);
    }

    function ajouterCouleur() {
      const div = document.createElement("div");
      div.innerHTML = `<label>Couleur :</label> <input type="color" name="couleur" data-type="color" data-id="${++compteur}">`;
      document.getElementById("effetlumieres").appendChild(div);
    }

    function ajouterAllumer() {
      const div = document.createElement("div");
      div.innerHTML = `<input type="hidden" data-type="action" value="turn_on" data-id="${++compteur}">💡 Allumer la lumière`;
      document.getElementById("effetlumieres").appendChild(div);
    }

    function ajouterEteindre() {
      const div = document.createElement("div");
      div.innerHTML = `<input type="hidden" data-type="action" value="turn_off" data-id="${++compteur}">🌑 Éteindre la lampe`;
      document.getElementById("effetlumieres").appendChild(div);
    }

    function ajouterPause() {
      const div = document.createElement("div");
      div.innerHTML = `<label>Pause (sec) :</label> <input type="number" min="0.1" step="0.1" data-type="pause" data-id="${++compteur}">`;
      document.getElementById("effetlumieres").appendChild(div);
    }

  let compteur = 0;

  function ajouterCouleur() {
    const div = document.createElement("div");
    const id = ++compteur;

    div.innerHTML = `
      <label>Couleur :</label>
      <input type="color" name="couleur" data-type="color" data-id="${id}" onchange="convertirHexEnRGB(this, ${id})">
      <input type="hidden" id="rgb-${id}" data-type="rgb">
    `;
    document.getElementById("effetlumieres").appendChild(div);
  }

  function convertirHexEnRGB(input, id) {
    const hex = input.value;
    const r = parseInt(hex.substring(1, 3), 16);
    const g = parseInt(hex.substring(3, 5), 16);
    const b = parseInt(hex.substring(5, 7), 16);
    const rgbField = document.getElementById(`rgb-${id}`);
    rgbField.value = JSON.stringify({ r, g, b });
  }

  function preparerEffets() {
    const effets = [];
    const inputs = document.querySelectorAll("#effetlumieres [data-type]");

    inputs.forEach(input => {
      const type = input.getAttribute("data-type");
      if (type === "color") {
        const id = input.getAttribute("data-id");
        const rgb = document.getElementById(`rgb-${id}`).value;
        effets.push({ type: "color", value: JSON.parse(rgb) });
      } else {
        effets.push({ type, value: input.value });
      }
    });

    document.getElementById("effets_json").value = JSON.stringify(effets);
  }

  </script>
</body>
</html>

